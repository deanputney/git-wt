#!/bin/bash
#
# git-crypt pre-worktree-add hook
#
# This hook works around the known incompatibility between git-crypt and git worktree.
# Install this to .git/hooks/pre-worktree-add to enable git-crypt support.
#
# INSTALLATION:
#   cp examples/hooks/git-crypt-pre-worktree-add .git/hooks/pre-worktree-add
#   cp examples/hooks/git-crypt-post-worktree-add .git/hooks/post-worktree-add
#   chmod +x .git/hooks/pre-worktree-add .git/hooks/post-worktree-add

# Check if git-crypt is in use
if ! git config --get filter.git-crypt.smudge >/dev/null 2>&1; then
  # git-crypt not configured, nothing to do
  exit 0
fi

# Save the current git-crypt filter settings to environment variables
export GIT_WT_SAVED_SMUDGE=$(git config filter.git-crypt.smudge 2>/dev/null || echo "")
export GIT_WT_SAVED_CLEAN=$(git config filter.git-crypt.clean 2>/dev/null || echo "")
export GIT_WT_SAVED_REQUIRED=$(git config filter.git-crypt.required 2>/dev/null || echo "")

# Temporarily disable git-crypt by setting filters to cat
# This prevents git-crypt errors during the initial checkout
# Unset required first so filter failures don't cause fatal errors
git config --unset filter.git-crypt.required || true
git config filter.git-crypt.smudge "cat"
git config filter.git-crypt.clean "cat"

exit 0
