#!/bin/bash
#
# git-wt-git-crypt-helper
#
# Helper script for git-wt to handle git-crypt worktree compatibility issues.
#
# This script works around the known incompatibility between git-crypt and git worktree
# that exists in all versions of git-crypt up to and including 0.8.0 (Sept 2024).
#
# USAGE:
#   To use this helper with git-wt hooks, you can either:
#
#   1. Create separate pre and post hooks:
#      - Copy this script to: .git/hooks/git-wt-pre-worktree-add
#      - Set HOOK_PHASE=pre at the top of that copy
#      - Copy this script to: .git/hooks/git-wt-post-worktree-add
#      - Set HOOK_PHASE=post at the top of that copy
#      - Make both executable: chmod +x .git/hooks/git-wt-*worktree-add
#
#   2. Or symlink both hooks to this script (it auto-detects phase from hook name):
#      - ln -s ../../git-wt-git-crypt-helper .git/hooks/git-wt-pre-worktree-add
#      - ln -s ../../git-wt-git-crypt-helper .git/hooks/git-wt-post-worktree-add
#      - chmod +x git-wt-git-crypt-helper
#
# HOOK PHASE:
#   This script can act as both pre and post hook. It determines which phase by:
#   1. Checking the HOOK_PHASE environment variable (set to 'pre' or 'post')
#   2. Or inferring from the script name if it contains 'pre' or 'post'

# Determine hook phase
if [ -n "$HOOK_PHASE" ]; then
  PHASE="$HOOK_PHASE"
elif [[ "$(basename "$0")" == *"pre"* ]]; then
  PHASE="pre"
elif [[ "$(basename "$0")" == *"post"* ]]; then
  PHASE="post"
else
  echo "git-wt-git-crypt-helper: Cannot determine hook phase (pre or post)" >&2
  echo "Set HOOK_PHASE=pre or HOOK_PHASE=post, or name the script with 'pre' or 'post'" >&2
  exit 1
fi

# Check if git-crypt is in use
if ! git config --get filter.git-crypt.smudge >/dev/null 2>&1; then
  # git-crypt not configured, nothing to do
  exit 0
fi

case "$PHASE" in
  pre)
    # PRE-WORKTREE-ADD: Save and temporarily disable git-crypt

    # Save the current filter.git-crypt.required setting
    required_setting=$(git config filter.git-crypt.required 2>/dev/null || echo "")

    # Store it for the post hook to restore
    export GIT_WT_SAVED_CRYPT_REQUIRED="$required_setting"

    # Temporarily disable git-crypt by removing the required flag
    # This prevents git worktree add from failing if git-crypt can't decrypt yet
    git config --unset filter.git-crypt.required || true

    # Signal to git worktree add that we need special handling
    # The actual worktree creation needs to use --no-checkout, but we can't
    # modify the command from here, so we'll handle everything in post hook
    ;;

  post)
    # POST-WORKTREE-ADD: Restore git-crypt and decrypt the new worktree

    # First argument is the worktree path
    worktree_path="$1"

    if [ -z "$worktree_path" ]; then
      echo "git-wt-git-crypt-helper: No worktree path provided to post hook" >&2
      exit 1
    fi

    # Restore the required setting if it existed
    if [ -n "$GIT_WT_SAVED_CRYPT_REQUIRED" ]; then
      git config filter.git-crypt.required "$GIT_WT_SAVED_CRYPT_REQUIRED"
    fi

    # Now handle the worktree: set filters to cat, checkout encrypted, then unlock

    # In the worktree, disable filters temporarily to get encrypted files
    git -C "$worktree_path" config filter.git-crypt.smudge "cat"
    git -C "$worktree_path" config filter.git-crypt.clean "cat"

    # This checkout will get the files in their encrypted state
    git -C "$worktree_path" reset --hard HEAD

    # Re-enable proper filters
    git -C "$worktree_path" config --unset filter.git-crypt.smudge
    git -C "$worktree_path" config --unset filter.git-crypt.clean

    # Unlock git-crypt in the new worktree
    if ! git -C "$worktree_path" crypt unlock 2>/dev/null; then
      echo "git-wt-git-crypt-helper: Warning: Could not unlock git-crypt in $worktree_path" >&2
      echo "You may need to run 'git crypt unlock' manually in the worktree" >&2
      # Don't fail - the worktree was created successfully
      exit 0
    fi

    # Final checkout to decrypt all files
    git -C "$worktree_path" reset --hard HEAD
    ;;

  *)
    echo "git-wt-git-crypt-helper: Unknown phase '$PHASE'" >&2
    exit 1
    ;;
esac

exit 0
